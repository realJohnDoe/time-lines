<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>YAML Timeline Stacked Bars (Full Width Responsive)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Optional: Hide y-overflow for timeline container */
      #timeline {
        overflow-y: hidden;
      }
    </style>
  </head>
  <body class="bg-gray-50 w-screen h-screen flex flex-col">
    <div class="flex flex-col-reverse md:flex-row w-full h-full">
      <!-- Sidebar: fixed bottom bar on mobile, left sidebar on md+ screens -->
      <div
        class="bg-white p-2 flex flex-col gap-2 rounded-t-xl md:rounded md:shadow md:p-4 md:w-[30rem] md:min-w-80 md:h-full"
      >
        <textarea
          id="yaml-input"
          class="border rounded font-mono p-2 w-full resize-none h-40 md:h-64 md:h-full"
          rows="6"
          placeholder="Paste your YAML here..."
        ></textarea>
        <button
          id="render-btn"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full"
        >
          Render Timeline
        </button>
      </div>
      <div
        id="timeline-wrapper"
        class="flex-1 relative overflow-x-auto overflow-y-hidden mx-4 py-2"
        style="min-width: 0"
      >
        <div id="timeline" class="relative h-full w-max min-w-full"></div>
        <div
          id="zoom-controls"
          class="absolute z-20 flex flex-row gap-2 bottom-8 right-0"
        >
          <button
            id="zoom-in"
            class="w-10 h-10 flex items-center justify-center bg-gray-300 hover:bg-gray-700 text-white text-2xl font-bold leading-none font-mono rounded shadow-sm transition"
            title="Zoom in (increase horizontal scale)"
          >
            +
          </button>
          <button
            id="zoom-out"
            class="w-10 h-10 flex items-center justify-center bg-gray-300 hover:bg-gray-700 text-white text-2xl font-bold leading-none font-mono rounded shadow-sm transition"
            title="Zoom out (decrease horizontal scale)"
          >
            –
          </button>
        </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
      <script>
        function parseDate(val) {
          if (!val) return null;
          if (val instanceof Date && !isNaN(val)) return val;
          if (typeof val === "number" && val > 999 && val < 3000) {
            // Unquoted year in YAML, e.g. 2023
            return new Date(val, 0, 1);
          }
          if (typeof val === "string") {
            const parts = val.trim().split("-");
            if (parts.length === 1 && /^\d{4}$/.test(parts[0])) {
              // Quoted year in YAML, e.g. "2023"
              return new Date(Number(parts[0]), 0, 1);
            }
            if (
              parts.length === 2 &&
              /^\d{4}$/.test(parts[0]) &&
              /^\d{1,2}$/.test(parts[1])
            ) {
              // Quoted year-month in YAML, e.g. "2023-07"
              return new Date(Number(parts[0]), Number(parts[1]) - 1, 1);
            }
          }
          // Debug log for unsupported formats
          console.warn("[parseDate] Unsupported date format or value:", val);
          return null;
        }

        function formatDate(date) {
          if (!date) return "";
          const y = date.getFullYear();
          const m = date.getMonth() + 1;
          return m === 1 ? `${y}` : `${y}-${String(m).padStart(2, "0")}`;
        }
        function assignLevels(topics) {
          topics.sort((a, b) => a.startDate - b.startDate);
          const levels = [];
          for (const topic of topics) {
            let lvl = 0;
            while (true) {
              const conflict = levels[lvl]?.some(
                (t) =>
                  !(
                    topic.endDate <= t.startDate || topic.startDate >= t.endDate
                  )
              );
              if (!conflict) break;
              lvl++;
            }
            if (!levels[lvl]) levels[lvl] = [];
            levels[lvl].push(topic);
            topic.level = lvl;
          }
          return topics.sort(
            (a, b) => b.level - a.level || b.startDate - a.startDate
          );
        }
        function isToday(date) {
          const now = new Date();
          return (
            date.getFullYear() === now.getFullYear() &&
            date.getMonth() === now.getMonth() &&
            date.getDate() === now.getDate()
          );
        }

        let zoomLevel = 1;
        const minZoom = 1;
        const maxZoom = 10;

        function handleZoom(delta) {
          const oldZoom = zoomLevel;
          zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel + delta));
          if (zoomLevel !== oldZoom) render();
        }

        document.getElementById("zoom-in").onclick = () => handleZoom(1);
        document.getElementById("zoom-out").onclick = () => handleZoom(-1);

        function renderTimeline(
          topics,
          minDate,
          maxDate,
          barHeight,
          barGap,
          xZoom,
          containerWidth
        ) {
          const maxLevel = Math.max(...topics.map((t) => t.level));
          const totalHeight = (maxLevel + 1) * (barHeight + barGap) + 48; // 48 for axis/labels padding

          // Responsive: inner timeline width is containerWidth * xZoom, min 800px
          const timelineWidth = Math.max(containerWidth * xZoom, 800);

          // Calculate year step to avoid label collision
          const totalYears = maxDate.getFullYear() - minDate.getFullYear() + 1;
          let yearStep = 1;
          if (totalYears / xZoom > 12) yearStep = 2;
          if (totalYears / xZoom > 24) yearStep = 5;
          if (totalYears / xZoom > 60) yearStep = 10;

          // Build year ticks (every yearStep years)
          const years = [];
          for (
            let y = minDate.getFullYear();
            y <= maxDate.getFullYear();
            y += yearStep
          )
            years.push(y);

          function dateToX(date) {
            return (
              ((date - minDate) / (maxDate - minDate)) * (timelineWidth - 80) +
              60
            );
          }

          return `
  <div style="width:${timelineWidth}px; height:100%; min-height:${totalHeight}px; position:relative;">
    <!-- Year Grid Lines -->
    <div class="absolute left-0 top-0 w-full h-full pointer-events-none z-0">
      ${years
        .map((year) => {
          const x = dateToX(new Date(year, 0, 1));
          return `
            <div style="position:absolute;left:${x}px;top:0;height:100%;width:1px;" class="border-l border-gray-200"></div>
          `;
        })
        .join("")}
    </div>
    <!-- Bars, bottom-aligned -->
    ${topics
      .map((topic) => {
        const x1 = dateToX(topic.startDate);
        const x2 = dateToX(topic.endDate);
        // Bars stack upwards from the bottom
        const barAreaBottom = 32;
        const barAreaHeight = totalHeight - barAreaBottom - 32; // Reserve space for top and bottom label
        const y =
          barAreaHeight -
          (topic.level + 1) * (barHeight + barGap) +
          barGap +
          32; // offset for top labels
        const color = topic.tags?.includes("Who?")
          ? "bg-yellow-500"
          : topic.tags?.includes("Where?")
          ? "bg-green-700"
          : topic.tags?.includes("What?")
          ? "bg-blue-700"
          : "bg-gray-400";
        const tooltip = [
          topic.name,
          `(${formatDate(topic.startDate)} → ${formatDate(topic.endDate)})`,
          ...(topic.tags || []),
        ].join(" | ");
        return `
<div class="absolute flex items-center shadow-sm ${color} text-white text-sm py-2 cursor-pointer hover:opacity-90"
    style="left:${x1}px; top:${y}px; width:${x2 - x1}px; height:${
          barHeight - 8
        }px; z-index:10;"
    title="${tooltip.replace(/"/g, "&quot;")}">
    ${
      topic.tags?.includes("fuzzy-start")
        ? `<span class="absolute left-0" 
              style="top:-5%; height:110%; width:10px; border-radius:2px;
              background: linear-gradient(to right, rgba(255,255,255,0.8), transparent);"></span>`
        : `<span class="absolute left-0 ${color}" 
              style="top:-5%; height:110%; width:2px; border-radius:2px;"></span>`
    }
    ${
      topic.tags?.includes("fuzzy-end") || isToday(topic.endDate)
        ? `<span class="absolute right-0" 
              style="top:-5%; height:110%; width:10px; border-radius:2px;
              background: linear-gradient(to left, rgba(255,255,255,0.8), transparent);"></span>`
        : `<span class="absolute right-0 ${color}" 
              style="top:-5%; height:110%; width:2px; border-radius:2px;"></span>`
    }
    <span class="w-full text-center font-semibold overflow-hidden whitespace-nowrap text-ellipsis">
      ${topic.name}
    </span>
</div>
`;
      })
      .join("")}
    <!-- Year Labels at Top -->
    <div class="absolute left-0 w-full"
         style="top:0;height:32px;pointer-events:none;">
      ${years
        .map((year) => {
          const x = dateToX(new Date(year, 0, 1));
          return `<span style="position:absolute;left:${x}px;top:0;transform:translateX(-50%);width:50px;text-align:center;white-space:nowrap;font-size:12px;color:#888;background:rgba(255,255,255,0.8);z-index:5;">
            ${year}
          </span>`;
        })
        .join("")}
    </div>
    <!-- Year Labels at Bottom -->
    <div class="absolute left-0 w-full"
         style="bottom:0;height:32px;pointer-events:none;">
      ${years
        .map((year) => {
          const x = dateToX(new Date(year, 0, 1));
          return `<span style="position:absolute;left:${x}px;bottom:0;transform:translateX(-50%);width:50px;text-align:center;white-space:nowrap;font-size:12px;color:#888;background:rgba(255,255,255,0.8);z-index:5;">
            ${year}
          </span>`;
        })
        .join("")}
    </div>
  </div>
`;
        }

        function render() {
          const yamlText = document.getElementById("yaml-input").value;
          let data;
          try {
            data = jsyaml.load(yamlText);
          } catch (e) {
            document.getElementById(
              "timeline"
            ).innerHTML = `<div class="text-red-600">YAML Parse Error: ${e.message}</div>`;
            return;
          }
          if (!data || !Array.isArray(data.topics)) {
            document.getElementById(
              "timeline"
            ).innerHTML = `<div class="text-red-600">No topics found in YAML.</div>`;
            return;
          }
          // Use current date if end is missing
          const topics = data.topics
            .map((t) => ({
              ...t,
              startDate: parseDate(t.start),
              endDate: t.end ? parseDate(t.end) : new Date(),
            }))
            .filter((t) => t.startDate && t.endDate);
          if (!topics.length) {
            document.getElementById(
              "timeline"
            ).innerHTML = `<div class="text-red-600">No valid topics with start and end dates.</div>`;
            return;
          }
          const minDate = new Date(Math.min(...topics.map((t) => t.startDate)));
          const maxDate = new Date(Math.max(...topics.map((t) => t.endDate)));
          assignLevels(topics);
          const barHeight = 36;
          const barGap = 2;
          const xZoom = zoomLevel;

          // Responsive: get the width of the timeline container (full screen width)
          const containerWidth =
            document.getElementById("timeline").clientWidth ||
            window.innerWidth;

          document.getElementById("timeline").innerHTML = renderTimeline(
            topics,
            minDate,
            maxDate,
            barHeight,
            barGap,
            xZoom,
            containerWidth
          );
          // Dynamically set timeline container height to fit content
          const maxLevel = Math.max(...topics.map((t) => t.level));
          const totalHeight = (maxLevel + 1) * (barHeight + barGap) + 48;
        }

        document.getElementById("render-btn").onclick = render;

        window.addEventListener("resize", render);

        // Example YAML for convenience
        document.getElementById("yaml-input").value = `topics:
  - name: person a
    start: 2011-07
    end: 2015-09
    tags:
      - Who?
  - name: location 1
    start: 2005
    end: 2018
    tags:
      - Where?
  - name: project x
    start: 2014-01
    end: 2016-06
    tags:
      - What?
  - name: person b
    start: 2015-01
    # end is missing, will use current date
    tags:
      - Who?
`;
        // Initial render
        render();
      </script>
    </div>
  </body>
</html>
